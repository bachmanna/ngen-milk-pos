{% extends "layout.jinja2" %}

{% block breadcrumb %}
<li>{{_("SHIFT")}}: <span id="collection_shift">{{ _(shift) }}</span></li>
{% endblock %}

{% block body %}

<div class=" collection-wrapper">
	<div class="row">
		<div class="medium-12 columns">
			<h1>
				{{_("Milk Collection")}}
				<small id="edit_date">{{date.strftime("%d/%m/%Y %I:%M%p")}}</small>
			</h1>
		</div>
	</div>

	<div class="row">
		<div class="medium-12 columns">
			<form name="frmCollection" id="frmCollection" method="post" action="">
				<input type="hidden" name="collection_id" id="collection_id" value=""/>
				<input type="hidden" name="created_at" id="created_at" value="{{date}}"/>
				<input type="hidden" name="shift" id="shift" value="{{shift}}"/>
				<div class="row">
					<div class="medium-2 columns">
						<label for="member_code">{{_("M.Code")}}</label>
					</div>
					<div class="medium-2 columns">
						<input type="text" class="mousetrap" id="member_code" name="member_code" />
					</div>
					<div class="medium-4 columns">
						<div id="member_name"></div>
					</div>
					<div class="medium-2 columns text-right">
						<label>{{_("Cattle")}}</label>
					</div>
					<div class="medium-2 columns end">
						<div id="member_cattle_type"></div>
					</div>
				</div>
				<br/>
				<div class="row">
					<div class="medium-1 columns">
						<label>{{_("FAT")}}</label>
					</div>
					<div class="medium-5 columns">
						<input class="mousetrap" type="text" {{ "" if settings.get("MANUAL_FAT") == "True" else "disabled"}} name="fat" id="fat" />
					</div>
					<div class="medium-1 columns">
						<label>{{_("CLR")}}</label>
					</div>
					<div class="medium-5 columns">
						<input class="mousetrap" type="text" name="clr" id="clr"/>
					</div>
				</div>
				<br/>
				<div class="row">
					<div class="medium-1 columns">
						<label>{{_("SNF")}}</label>
					</div>
					<div class="medium-5 columns">
						<input class="mousetrap" type="text" {{ "" if settings.get("MANUAL_SNF") == "True" else "disabled"}} name="snf" id="snf"/>
					</div>
					<div class="medium-1 columns">
						<label>{{_("AW")}}</label>
					</div>
					<div class="medium-5 columns">
						<input class="mousetrap" type="text" name="water" id="water" />
					</div>
				</div>
				<br/>
				<div class="row">
					<div class="medium-1 columns">
						<label>{{_("QTY")}}</label>
					</div>
					<div class="medium-5 columns end">
						<input class="mousetrap" type="text" {{ "" if settings.get("MANUAL_QTY") == "True" else "disabled"}} name="qty" id="qty" />
					</div>
				</div>
				<div class="row">
					<div class="medium-1 columns" style="line-height: 110px;">
						<span>{{_("RATE")}}</span>
					</div>
					<div class="medium-4 columns">
						<div class="text-right">
							<span id="rate">00.00</span>
						</div>
						<input type="hidden" name="rate" id="txtRate" />
					</div>
					<div class="medium-2 columns text-right" style="line-height: 110px;">
						<span>{{_("TOTAL")}}</span>
					</div>
					<div class="medium-5 columns end text-right">
						<span id="total">000.00</span>
						<input type="hidden" name="total" id="txtTotal" />
					</div>
				</div>
			</form>
		</div>
	</div>
</div>
<div class="row">
	<div class="medium-12 columns hide">
		<div class="alert-box alert" id="member_status"></div>
	</div>
</div>
<div id="prev_error_msg">
	{% include "flash_messages.jinja2" %}
</div>

{% endblock %}

{% block sidebar %}
<div class="row">
	<div class="medium-12 columns">
		<p>
			{{_("Press: <em>T</em> to tare scale")}}
			<br/>
			{{_("Press: <em>Z</em> to tare can")}}
		</p>
	</div>
</div>
<div class="row">
	<div class="medium-6 columns">
		{{_("Total Qty")}} <br/>
		{{_("COW")}} <br/>
		{{_("BUFFALO")}} 
	</div>
	<div class="medium-6 columns">
		<b id="total_milk">{{'%0.2f'| format(summary["milk"][0]+summary["milk"][1]|float)}}</b>&nbsp;{{_("litres")}}<br/>
		{{'%0.2f'| format(summary["milk"][0]|float)}}&nbsp;{{_("litres")}}<br/>
		{{'%0.2f'| format(summary["milk"][1]|float)}}&nbsp;{{_("litres")}}
	</div>
</div>
<br/>
<div class="row">
	<div class="medium-6 columns">
		{{_("Total Mem")}} <br/>
		{{_("COW")}} <br/>
		{{_("BUFFALO")}} 
	</div>
	<div class="medium-6 columns">
		<b id="total_member">{{summary["member"][0]+summary["member"][1]}}</b><br/>
		{{summary["member"][0]}}<br/>
		{{summary["member"][1]}}
	</div>
</div>
{% endblock %}

{% block statusbar %}
<div class="row action-buttons">
	<div class="medium-2 columns">
		<a href="#" id="btnSave" data-key="s" class="success button expand">S - {{_("SAVE")}}</a>
	</div>
	<div class="medium-2 columns">
		<a href="#" id="btnClear" data-key="c" class="button expand">C - {{_("CLEAR")}}</a>
	</div>
	<div class="medium-3 columns">
		<a href="#" data-key="d" class="button expand" data-reveal-id="dateChangeModal">D - {{_("CHANGE DATE")}}</a>
	</div>
	<div class="medium-2 columns end">
		<a href="/" data-key="esc" class="warning button expand">ESC - {{_("EXIT")}}</a>
	</div>
	<a href="#" onclick="$('#member_code').focus();" data-key="f" class="hide"></a>
</div>
<div id="dateChangeModal" class="reveal-modal tiny" data-reveal>
	<h3>{{_("Change Date")}}</h3>
	<form name="frmChangeDate" id="frmChangeDate" method="get" class="inline">
		<div class="row">
			<div class="medium-12 columns">
				<label>{{_("Date")}}</label>
				<input type="text" class="mousetrap tiny" name="day" value="{{date.day}}" />
				/
				<input type="text" class="mousetrap tiny" name="month" value="{{date.month}}"/>
				/
				<input type="text" class="mousetrap medium" name="year" value="{{date.year}}" />
			</div>
		</div>
		<br/>
		<div class="row">
			<div class="medium-12 columns">
				<label>{{_("Time")}}</label>
				<input type="text" class="mousetrap tiny" name="hour" value="{{date.strftime("%I")}}" />
				/
				<input type="text" class="mousetrap tiny" name="minute" value="{{date.strftime("%M")}}"/>
				/
				<input type="text" class="mousetrap medium" name="dn" value="{{date.strftime("%p")}}" />
			</div>
		</div>
		<br/>
		<div class="row">
			<div class="medium-7 columns">
				&nbsp;
			</div>
			<div class="medium-5 columns end">
				<button type="submit" name="btnChangeDate" value="True" class="expand button">{{_("Change")}}</button>
			</div>
		</div>
	</form>
	<a class="close-reveal-modal">&#215;</a>
</div>
{% endblock %}

{% block scripts %}
<script>
	$(function(){
		var error_member_no_found = '{{_("Member not found!")}}';
		var error_milk_already_collected = '{{_("Milk already collected!")}}';
		var members = {{members_json}};

		function showError (msg) {
			$("#member_status").parent().removeClass("hide");
			$("#member_status").text(msg);
		}

		function hideError () {
			$("#prev_error_msg").remove();
			$("#member_status").parent().addClass("hide");
			$("#member_status").text("");
		}

		function updateData(member_id){
			var shift = $("input[name=shift]").val();
			var cattle_type = $("#member_cattle_type").text().trim();
			var created_at = $("input[name=created_at]").val();
			$.get('/get_collection_data', {"member_id": member_id,"created_at":created_at,"shift":shift,"cattle_type": cattle_type},function(data){
				$("#fat").val(data.fat);
				$("#snf").val(data.snf);
				$("#clr").val(data.clr);
				$("#water").val(data.water);
				$("#qty").val(data.qty);
				$("#rate").text(data.rate);
				$("#total").text(data.total);
				$("#txtRate").val(data.rate);
				$("#txtTotal").val(data.total);
				$("#collection_id").val("");

				if(data.collection_id && parseInt(data.collection_id) > 0) {
					$("#collection_id").val(data.collection_id);
					$("input[name=created_at]").val(data.created_at);
					//$("#shift").val(data.shift);
					showError(error_milk_already_collected);
				}
			});
		}

		function clearData(){
			$("ul.flashes").remove();
			$("#member_status").parent().addClass("hide");
			$("#member_status").text("");
			$("#member_name").text("");
			$("#member_cattle_type").text("");

			$("#member_code").val("");
			$("#fat").val("");
			$("#snf").val("");
			$("#clr").val("");
			$("#water").val("");
			$("#qty").val("");
			$("#collection_id").val("");

			$("#rate").text("00.00");
			$("#total").text("000.00");			
			$("#txtRate").val("");
			$("#txtTotal").val("");
			$("#member_code").focus();
		}

		$("#member_code").on("keypress",function(e){
			if(e.keyCode == 13){
				hideError();
				$("#member_name").text("");
				$("#member_cattle_type").text("");
				var code = parseInt($(this).val());

				if(isNaN(code)){
					code = "";
					return;
				}

				var res = $.grep(members, function(x){ return x.id == code; });
				if(res && res.length == 1) {				
					var m = res[0];
					$("#member_name").text(m.name);
					$("#member_cattle_type").text(m.cattle_type);
					updateData(code);
				}else{
					clearData();
					$("#member_code").val(code);
					showError(error_member_no_found);
				}
			}
		});

		$("#btnSave").click(function(){
			$("input[disabled]").prop("disabled", null);
			$("#frmCollection").submit();
			return false;
		});

		$("#btnClear").click(function(){
			clearData();
			return false;
		});

		clearData();

		$(document).on('opened.fndtn.reveal', '#dateChangeModal', function () {
			console.log($(this));
			Mousetrap.pause();
			$("input[name=day]").focus();
		});

		$(document).on('closed.fndtn.reveal', '#dateChangeModal', function () {
			console.log($(this));
			Mousetrap.unpause();
			$("#member_code").focus();
		});
	});
</script>
{% endblock %}